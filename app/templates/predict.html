{% extends "base.html" %}

{% block title %}Match Predictor - Soccer Analytics{% endblock %}

{% block extra_css %}
<style>
    .prediction-form {
        background: #f8f9fa;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .result-box {
        background: white;
        padding: 30px;
        border-radius: 10px;
        border: 2px solid #ddd;
        margin-top: 30px;
        display: none;
    }
    
    .probability-bar {
        margin: 15px 0;
    }
    
    .probability-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .bar-container {
        width: 100%;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        height: 30px;
    }
    
    .bar-fill {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        transition: width 0.5s ease;
    }
    
    .bar-home {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    }
    
    .bar-draw {
        background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bar-away {
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .team-attrs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .attr-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
    }
    
    .attr-box h4 {
        margin-bottom: 15px;
        color: #2c3e50;
    }
    
    .loading {
        text-align: center;
        padding: 20px;
        display: none;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<h2>âš½ Match Outcome Predictor</h2>
<p style="color: #666; margin-bottom: 30px;">
    Select two teams and our ML model will predict the match outcome based on team attributes and historical data.
</p>

<div class="prediction-form">
    <form id="predictionForm">
        <div class="form-group">
            <label for="homeTeam">Home Team:</label>
            <select id="homeTeam" name="homeTeam" required>
                <option value="">-- Select Home Team --</option>
                {% for team in teams %}
                <option value="{{ team }}">{{ team }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="awayTeam">Away Team:</label>
            <select id="awayTeam" name="awayTeam" required>
                <option value="">-- Select Away Team --</option>
                {% for team in teams %}
                <option value="{{ team }}">{{ team }}</option>
                {% endfor %}
            </select>
        </div>
        
        <button type="submit" class="btn" id="predictBtn">Predict Match Outcome</button>
    </form>
</div>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 15px;">Analyzing teams and predicting outcome...</p>
</div>

<div class="result-box" id="resultBox">
    <h3 style="color: #2c3e50; margin-bottom: 20px;">Prediction Results</h3>
    
    <div style="text-align: center; padding: 20px; background: #667eea; color: white; border-radius: 10px; margin-bottom: 20px;">
        <h2 id="matchup" style="margin-bottom: 10px;"></h2>
        <p style="font-size: 24px; font-weight: bold;" id="prediction"></p>
        <p id="confidence"></p>
    </div>
    
    <h4 style="margin-bottom: 15px; color: #2c3e50;">Win Probabilities:</h4>
    
    <div class="probability-bar">
        <div class="probability-label">
            <span>Home Win</span>
            <span id="homeWinPct">0%</span>
        </div>
        <div class="bar-container">
            <div class="bar-fill bar-home" id="homeWinBar" style="width: 0%"></div>
        </div>
    </div>
    
    <div class="probability-bar">
        <div class="probability-label">
            <span>Draw</span>
            <span id="drawPct">0%</span>
        </div>
        <div class="bar-container">
            <div class="bar-fill bar-draw" id="drawBar" style="width: 0%"></div>
        </div>
    </div>
    
    <div class="probability-bar">
        <div class="probability-label">
            <span>Away Win</span>
            <span id="awayWinPct">0%</span>
        </div>
        <div class="bar-container">
            <div class="bar-fill bar-away" id="awayWinBar" style="width: 0%"></div>
        </div>
    </div>
    
    <div class="team-attrs">
        <div class="attr-box">
            <h4 id="homeTeamName">Home Team</h4>
            <p>Overall Rating: <strong id="homeRating">0</strong></p>
            <p>Attack: <strong id="homeAttack">0</strong></p>
            <p>Defense: <strong id="homeDefense">0</strong></p>
        </div>
        
        <div class="attr-box">
            <h4 id="awayTeamName">Away Team</h4>
            <p>Overall Rating: <strong id="awayRating">0</strong></p>
            <p>Attack: <strong id="awayAttack">0</strong></p>
            <p>Defense: <strong id="awayDefense">0</strong></p>
        </div>
    </div>
</div>

<div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 5px;">
    <p style="color: #0c5460; margin: 0;">
        <strong>Model Info:</strong> This prediction uses a Gradient Boosting model trained on 25,000+ matches. 
        The model achieves 50% accuracy - typical for soccer prediction where draws are common and upsets happen frequently. 
        Recent form is the most important predictor (22% importance).
    </p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('predictionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const homeTeam = document.getElementById('homeTeam').value;
    const awayTeam = document.getElementById('awayTeam').value;
    
    if (!homeTeam || !awayTeam) {
        alert('Please select both teams');
        return;
    }
    
    if (homeTeam === awayTeam) {
        alert('Please select different teams');
        return;
    }
    
    // Show loading
    document.getElementById('loading').style.display = 'block';
    document.getElementById('resultBox').style.display = 'none';
    document.getElementById('predictBtn').disabled = true;
    
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                home_team: homeTeam,
                away_team: awayTeam
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            // Display results
            document.getElementById('matchup').textContent = `${data.home_team} vs ${data.away_team}`;
            document.getElementById('prediction').textContent = `Prediction: ${data.prediction}`;
            document.getElementById('confidence').textContent = `Confidence: ${data.confidence}%`;
            
            // Update probabilities
            document.getElementById('homeWinPct').textContent = `${data.probabilities.home_win}%`;
            document.getElementById('drawPct').textContent = `${data.probabilities.draw}%`;
            document.getElementById('awayWinPct').textContent = `${data.probabilities.away_win}%`;
            
            // Update bars
            document.getElementById('homeWinBar').style.width = `${data.probabilities.home_win}%`;
            document.getElementById('drawBar').style.width = `${data.probabilities.draw}%`;
            document.getElementById('awayWinBar').style.width = `${data.probabilities.away_win}%`;
            
            // Update team attributes
            document.getElementById('homeTeamName').textContent = data.home_team;
            document.getElementById('homeRating').textContent = data.team_attributes.home.rating;
            document.getElementById('homeAttack').textContent = data.team_attributes.home.attack;
            document.getElementById('homeDefense').textContent = data.team_attributes.home.defense;
            
            document.getElementById('awayTeamName').textContent = data.away_team;
            document.getElementById('awayRating').textContent = data.team_attributes.away.rating;
            document.getElementById('awayAttack').textContent = data.team_attributes.away.attack;
            document.getElementById('awayDefense').textContent = data.team_attributes.away.defense;
            
            // Show results
            document.getElementById('resultBox').style.display = 'block';
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert('Failed to get prediction. Please try again.');
        console.error(error);
    } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('predictBtn').disabled = false;
    }
});
</script>
{% endblock %}